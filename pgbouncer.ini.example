; =====================================================
; PgBouncer Configuration File
; =====================================================
; Description: Production configuration for subscription platform
; Target: 300-600 concurrent users with connection pooling
; Mode: Session pooling for balance of safety and performance

[databases]
; Database definitions
; Format: dbname = host=hostname port=port dbname=database user=username password=password
subscription_platform = host=localhost port=5432 dbname=subscription_platform user=subscription_user password=subscription_pass_2024

; Template for additional databases
; backup_db = host=localhost port=5432 dbname=backup_platform user=subscription_user password=subscription_pass_2024

; =====================================================
; PGBOUNCER SETTINGS
; =====================================================

[pgbouncer]

; ===== BASIC SETTINGS =====

; Listen address and port
listen_addr = 127.0.0.1
listen_port = 6432

; Authentication settings
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Admin database for monitoring (virtual database)
admin_users = subscription_user
stats_users = subscription_user

; ===== POOL SETTINGS =====

; Connection pooling mode
; session = (default) server is released back to pool after client disconnects
; transaction = server is released back to pool after transaction finishes
; statement = server is released back to pool after query finishes
pool_mode = session

; Maximum number of client connections allowed
max_client_conn = 500

; Default pool size (number of server connections to allow per user/database pair)
default_pool_size = 75

; Minimum pool size (connections to maintain at all times)
min_pool_size = 10

; Reserve pool size (additional connections for emergencies)
reserve_pool_size = 10

; Maximum connections per database
max_db_connections = 350

; Maximum connections per user
max_user_connections = 100

; ===== TIMEOUTS =====

; Server idle timeout (seconds) - how long to keep unused server connections
server_idle_timeout = 600

; Client idle timeout (seconds) - disconnect clients idle longer than this
client_idle_timeout = 600

; Server lifetime (seconds) - close server connection after this time
server_lifetime = 3600

; Client login timeout (seconds)
client_login_timeout = 60

; Query timeout (seconds) - cancel queries running longer than this
query_timeout = 900

; Query wait timeout (seconds) - maximum time to wait for connection from pool
query_wait_timeout = 120

; ===== DNS AND NETWORK =====

; DNS cache time (seconds)
dns_max_ttl = 15
dns_zone_check_period = 0

; TCP settings
tcp_defer_accept = 0
tcp_socket_buffer = 0
tcp_keepalive = 1
tcp_keepcnt = 0
tcp_keepidle = 0
tcp_keepintvl = 0

; ===== LOGGING SETTINGS =====

; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

; PID file location
pidfile = /var/run/pgbouncer/pgbouncer.pid

; Log level: 0=off 1=fatal 2=error 3=warning 4=info 5=debug 6=noise
log_level = 4

; Syslog settings (optional)
; syslog = 1
; syslog_facility = daemon
; syslog_ident = pgbouncer

; Log connections and disconnections
log_connections = 1
log_disconnections = 1

; Log pooler errors
log_pooler_errors = 1

; Log stats at regular intervals (seconds)
stats_period = 60

; ===== SECURITY AND ACCESS =====

; Ignore startup parameters
ignore_startup_parameters = extra_float_digits

; Application name to send to server
application_name_add_host = 1

; ===== PERFORMANCE TUNING =====

; Socket send/receive buffer sizes (0 = use system default)
so_reuseport = 1
server_check_delay = 30

; Disable server-side prepared statements (for compatibility)
server_reset_query = DISCARD ALL
server_reset_query_always = 0

; Auto-database creation (disabled for security)
autodb_idle_timeout = 3600

; ===== MEMORY AND BUFFERS =====

; Packet buffer size
pkt_buf = 4096

; Maximum packet size allowed
max_packet_size = 2147483647

; Listen queue size
listen_backlog = 128

; ===== CONNECTION LIMITS PER USER =====

; This section can be used to set per-user connection limits
; Format: username = pool_size
; [users]
; subscription_user = 50

; ===== ADDITIONAL SECURITY =====

; Server check query (to verify server health)
server_check_query = SELECT 1

; Disable dangerous SQL commands
disable_pqexec = 0

; Comma-separated list of parameters to ignore
; ignore_startup_parameters = search_path

; ===== MONITORING =====

; Enable collection of per-database stats
track_extra_parameters = IntervalStyle

; ===== UNIX SOCKET SETTINGS =====

; Unix socket directory (optional)
; unix_socket_dir = /var/run/pgbouncer
; unix_socket_mode = 0777
; unix_socket_group = pgbouncer